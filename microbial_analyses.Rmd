---
title: "microbial_analyses"
author: "Abigail Glascock"
date: "2025-10-13"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)
```

```{r load packages, message=FALSE, warning=FALSE}
library(magrittr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(stringi)
library(rstatix)
library(glue)
library(ggpubr)
library(svglite)
library(paletteer)
library(ggbeeswarm)
library(ggdist)
source("~/Downloads/stat_pvalue_manual.R")
source("/users/abigail.glascock/idseq.R")
```

```{r read in data}
### Import background-corrected microbe data 
microbe_reports<-read.csv("~/Downloads/full_dataset_VAP_bgc_010925.csv", header=TRUE) 

### Filter data 
microbes<-microbe_reports %>% 
  filter(nt_count>=1, nr_count>=1, nt_alignment_length>=50, p_adj<0.05) %>%
  dplyr::filter(category=="viruses" | nt_count>=10) 

### Read in metadata file and format
meta<-read.csv("~/IvC/revised_data_63025/metadata_newlabels_062725.csv", header=TRUE)
metadata<-meta %>% 
  mutate(age=X_AGE_YEARS,gender=X_SEX, category_infection_class=NEW_label_subclass)
metadata$age <-as.integer(metadata$age)

### Read in mapping file
map<-read.csv("~/patient_key.csv", header=TRUE)
map<-map %>% select(-sample_name)

### Join microbes to metadata
my_data<-microbes %>% 
  dplyr::mutate(sample_name_long=sample_name) %>%
  dplyr::mutate(sample_name=case_when(grepl("OPS054",sample_name) ~ str_extract(sample_name_long, ".*?OPS054"), TRUE ~ sample_name)) %>%
  left_join(metadata, by="sample_name") %>%
  filter(!is.na(patient_id)) %>%
  left_join(map, by="patient_id") 

microbe_matrix<-my_data %>%
  pivot_wider(names_from = name, id_cols = Patient,values_fill = 0, values_from = nt_count)

write.csv(microbe_matrix,"~/IvC/microbe_counts.csv")

```

```{r theme}
### set theme for figures 
theme_mine <-function(base_size=12,base_family=""){
  theme_bw(base_size,base_family=base_family) %+replace%
    theme(
      strip.background = element_blank(),
      strip.text.x = element_text(size=12),
      strip.text.y = element_text(size=12),
      axis.text.x = element_text(size=12),
      axis.text.y = element_text(size=12,hjust = 1),
      axis.ticks = element_line(colour = "black"),
      axis.title.x = element_blank(),
      axis.title.y = element_text(size = 12,angle = 90, vjust=2),
      legend.position = "right",legend.text=element_text(size=12),
      panel.background = element_blank(),
      panel.border = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.spacing = unit(1.0,"lines"),
      plot.background = element_blank(),
      plot.margin = unit(c(0.5,0.5,0.5,0.5),"lines"),
      axis.line = element_line(colour = "black")
    )
}
theme_set(theme_mine())

```

### Microbial Load - Bacteria ###

```{r microbial load bacteria}
load_data <- my_data %>%
  filter(category=="bacteria") %>%
  group_by(sample_name) %>%
  dplyr::mutate(summed_rpm = sum(nt_rpm)) %>% 
  dplyr::mutate(pseudo=summed_rpm+1) %>%
  dplyr::mutate(sumlogrpm = log10(pseudo)) %>% # calculate sumrpm and transform for each sample
  ungroup() %>%
  mutate(infection_derived=case_when(
    grepl("LRTI", category_infection_class) ~ "LRTI", 
    grepl("colonizer", category_infection_class) ~ "IPC", 
    grepl("Control", category_infection_class, ignore.case = TRUE) ~ "CTRL",
    TRUE ~ "NA")) %>% 
  filter(infection_derived!="NA") %>%
  filter(grepl("Bacterial|Control",category_infection_class)) %>%
  mutate(category_derived=case_when(
    grepl("Bacterial LRTI", category_infection_class) ~ "Bacterial\nLRTI", 
    grepl("Bacterial/viral LRTI", category_infection_class) ~ "Bacterial/viral\nLRTI", 
    grepl("Bacterial colonizer", category_infection_class) ~ "Bacterial\nIPC", 
    grepl("Bacterial/viral colonizer", category_infection_class) ~ "Bacterial/viral\nIPC", 
    grepl("Control", category_infection_class, ignore.case = TRUE) ~ "CTRL",
    TRUE ~ "NA")) %>% 
  dplyr::mutate(sumlogrpm = ifelse(is.na(sumlogrpm), 0, sumlogrpm)) %>% # set sum dpm to 0 if it's NA
  distinct(sample_name, sumlogrpm, infection_derived, category_derived, gender, age, summed_rpm, category_infection_class) 

my_order<-c("LRTI", "IPC", "CTRL")
group_positions=setNames(seq_along(my_order), my_order)

label_piece<-"P[adj]=="

stats <-load_data %>% 
  wilcox_test(data=.,sumlogrpm ~ infection_derived) %>%
  add_significance("p") %>%
  adjust_pvalue(method = "bonferroni") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  mutate(y.position = c(6.5,7,7.5)) %>%
  mutate(xmin=pmin(group_positions[group1], group_positions[group2])) %>%
  mutate(xmax=pmax(group_positions[group1], group_positions[group2])) %>%
  mutate(p_char = case_when(p.adj<0.01 ~ format(p.adj, scientific=TRUE, digits=2), p.adj>0.045 & p.adj<0.05 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), p.adj>0.0095 & p.adj<0.01 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p.adj,digits=2), nsmall = 2)))) 

stats$p_char2<-paste0(label_piece,stats$p_char)
stats$lab<-paste0(label_piece," ")

myplot1<-ggplot(load_data, aes(x=factor(infection_derived,my_order), y=sumlogrpm, color=infection_derived)) +
  scale_color_manual(values = c("gray","#008080FF","#CA562CFF"), na.value="gray2") +
  #geom_point(position = position_jitterdodge(0.3,0.2,0.6), alpha=0.6, size=3) +
  geom_quasirandom(alpha = 0.5, size = 2.5, dodge.width = 0.6) + 
  geom_boxplot(alpha=0.5, outlier.shape=NA, fill=NA, width=0.6) +
  xlab("Infection Status") + ylab("Log-transformed bacterial sum NT RPM") + labs(color="", title="Bacterial abundance by group") + 
  #geom_line(group="pt_id") + ### add this line if before and after with same patient
    geom_text(data = stats,
    aes(x = (xmin+xmax)/2, y = y.position*1.035, label = p_char2),
    inherit.aes = FALSE,
    size = 4,
    parse = TRUE) +
  geom_segment(data = stats,
    aes(x = xmin, xend = xmax, y = y.position, yend = y.position),
    inherit.aes = FALSE,
    size = 0.5,
    color = "black") +
  theme(legend.position="blank",plot.title = element_text(hjust = 0.5,size=12))
myplot1

my_order_big=c("Bacterial\nLRTI", "Bacterial/viral\nLRTI", "Bacterial\nIPC", "Bacterial/viral\nIPC", "CTRL")
group_positions1 <- setNames(seq_along(my_order_big), my_order_big)


statsa <-load_data %>% 
  filter(grepl("Control|Bacterial",category_infection_class))%>%
  wilcox_test(data=.,sumlogrpm ~ category_derived) %>%
  add_significance("p") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  filter(p.adj<0.1) %>%
  mutate(y.position = c(6.5,7)) %>%
  mutate(xmin=pmin(group_positions1[group1], group_positions1[group2])) %>%
  mutate(xmax=pmax(group_positions1[group1], group_positions1[group2])) %>%
  mutate(p_char = case_when(p.adj<0.01 ~ format(p.adj, scientific=TRUE, digits=2), p.adj>0.045 & p.adj<0.05 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), p.adj>0.0095 & p.adj<0.01 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p.adj,digits=2), nsmall = 2)))) 

statsa$p_char2<-paste0(label_piece,statsa$p_char)

trimmed<-load_data %>% filter(grepl("Control|Bacterial",category_infection_class))
my_label<-paste0("Log-transformed bacterial ",expression(sum)," NT RPM")

myplot1a<-ggplot(trimmed, aes(x=factor(category_derived, my_order_big), y=sumlogrpm, color=category_derived)) +
  scale_color_manual(values = c("#008080FF", "#CA562CFF","#70A494FF","#DE8A5AFF","gray"), na.value="gray2") +
  #geom_point(position = position_jitterdodge(0.3,0.2,0.6), alpha=0.6, size=3) +
  geom_quasirandom(alpha = 0.5, size = 2.5, dodge.width = 0.6) + 
  geom_boxplot(alpha=0.5, outlier.shape=NA, fill=NA, width=0.6) +
  xlab("Infection Status") + ylab(expression(paste("Log-transformed bacterial ", Sigma ,"(NT RPM)"))) + labs(color="", title="Bacterial abundance by subgroup") + 
  #geom_line(group="pt_id") + ### add this line if before and after with same patient
    geom_text(data = statsa,
    aes(x = (xmin+xmax)/2, y = y.position*1.04, label = p_char2),
    inherit.aes = FALSE,
    size = 4,
    parse = TRUE) +
  geom_segment(data = statsa,
    aes(x = xmin, xend = xmax, y = y.position, yend = y.position),
    inherit.aes = FALSE,
    size = 0.5,
    color = "black") +
  theme(axis.text.x = element_text(), legend.position="blank",plot.title = element_text(hjust = 0.5, size=12))
myplot1a

png(file="~/IvC/Figures/101325/Fig_2C.png", 5,5,"in",res=300)
plot(myplot1)
invisible(capture.output(dev.off()))

png(file="~/IvC/Figures/101325/SuppFig_S3A.png",8,5,"in",res=300)
plot(myplot1a)
invisible(capture.output(dev.off()))


```

### GLM corrected for gender and age

```{r}
myglm_data<-load_data %>% 
  mutate(gender = factor(gender, levels=c("Male", "Female")))
myglm<-glm(sumlogrpm ~ infection_derived + gender + age, data = myglm_data)
summary(myglm)

myglm_data<-trimmed %>% 
  mutate(gender = factor(gender, levels=c("Male", "Female")))
myglm<-glm(sumlogrpm ~ category_derived + gender + age, data = myglm_data)
summary(myglm)
```

### Microbial Load - Viruses ###

```{r microbial load virus}
load_data <- my_data %>%
  filter(nt_count>=1, nr_count>=1, nt_alignment_length>=50, p_adj<0.05) %>%
  filter(category=="viruses") %>%
  filter(!grepl("Haemophilus virus HP1|phage|Pseudomonas virus EL|Cucumber|Tobacco|Sanxia|Norway|Malassezia|Skokie|Yersinia virus AP10|Cherry|Corynebacterium virus|Blacklegged|Ohio|Clinch| Darwin|Brassica|Totivirus|Kadipiro|Ribgrass|Phaseolus|Newfield|Sinai|Sclerotinia|Inoviridae|Pepper mild|Propionibacterium virus|Tomato|Alfalfa|Bovine|Clover|Botrytis|Arthrobacter virus|Rabovirus|Myoviridae|anemone|Bermuda grass|Lasius|Perth bee|Mycobacterium virus|Tulip|Lysoka|Beauveria|Bell pepper|Newington|Prunus|Shahe|Cocksfoot|Soybean|Sinu virus|tombus-like|Pistacia|Brome|Kashmir bee|Streptomyces virus|Squash|Mississippi|Moroccan|Microbacterium virus|Turnip|Potato|Carnation|Hubei picorna-like virus 55|Opossum|Persea|Ryegrass|Micalovirus|Hubei tombus-like virus 31|Lactuca|Paramecium|Pectinobacterium|Oryza|Pseudomonas virus|Invertebrate|crawfish|Burkholderia|Hubei picorna-like virus 36|Sanfarnavirus|Streptococcus virus|Mamestra|Linepithema|Cockroach|Culex|Klebsiella virus|Hubei picorna-like virus 61|Carascovirus|Ubei picorna",name)) %>%
  group_by(sample_name) %>%
  dplyr::mutate(summed_rpm = sum(nt_rpm)) %>% 
  dplyr::mutate(pseudo=summed_rpm+1) %>%
  dplyr::mutate(sumlogrpm = log10(pseudo)) %>% # calculate sumrpm and transform for each sample
  ungroup() %>%
  left_join(metadata %>% dplyr::select(sample_name, category_infection_class, gender, age)) %>%
  mutate(infection_derived=case_when(
    grepl("LRTI", category_infection_class) ~ "LRTI", 
    grepl("colonizer", category_infection_class) ~ "IPC", 
    grepl("Control", category_infection_class, ignore.case = TRUE) ~ "CTRL",
    TRUE ~ "NA")) %>% 
  filter(infection_derived!="NA") %>%
  filter(grepl("Viral|Control|viral",category_infection_class)) %>%
  mutate(category_derived=case_when(
    grepl("Viral LRTI", category_infection_class) ~ "Viral\nLRTI", 
    grepl("Bacterial/viral LRTI", category_infection_class) ~ "Bacterial/viral\nLRTI", 
    grepl("Viral colonizer", category_infection_class) ~ "Viral\nIPC", 
    grepl("Bacterial/viral colonizer", category_infection_class) ~ "Bacterial/viral\nIPC", 
    grepl("Control", category_infection_class, ignore.case = TRUE) ~ "CTRL",
    TRUE ~ "NA")) %>% 
  dplyr::mutate(sumlogrpm = ifelse(is.na(sumlogrpm), 0, sumlogrpm)) %>% # set sum dpm to 0 if it's NA
  distinct(sample_name, sumlogrpm, infection_derived, gender, age, summed_rpm, category_infection_class, category_derived) 

my_order<-c("LRTI", "IPC", "CTRL")
group_positions=setNames(seq_along(my_order), my_order)

stats <-load_data %>% 
  wilcox_test(data=.,sumlogrpm ~ infection_derived) %>%
  add_significance("p") %>%
  adjust_pvalue(method = "bonferroni") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  mutate(xmin=pmin(group_positions[group1], group_positions[group2])) %>%
  mutate(xmax=pmax(group_positions[group1], group_positions[group2])) %>%
  mutate(y.position = c(5.5,6,6.5)) %>%
  mutate(p_char = case_when(p.adj<0.01 ~ format(p.adj, scientific=TRUE, digits=2), p.adj>0.045 & p.adj<0.05 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), p.adj>0.0095 & p.adj<0.01 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p.adj,digits=2), nsmall = 2)))) %>%
    mutate(p_char2=paste0("P[adj]==", p_char))

myplot1<-ggplot(load_data, aes(x=factor(infection_derived,my_order), y=sumlogrpm, color=infection_derived)) +
  scale_color_manual(values = c("gray","#008080FF","#CA562CFF"), na.value="gray2") +
  #geom_point(position = position_jitterdodge(0.3,0.2,0.6), alpha=0.6, size=3) +
  geom_quasirandom(alpha = 0.5, size = 2.5, dodge.width = 0.6) + 
  geom_boxplot(alpha=0.5, outlier.shape=NA, fill=NA, width=0.6) +
  xlab("Infection Status") + ylab(expression(paste("Log-transformed viral ", Sigma, "(NT RPM)"))) + labs(color="", title="Viral abundance by group") + 
  #geom_line(group="pt_id") + ### add this line if before and after with same patient
  geom_text(data = stats,
    aes(x = (xmin+xmax)/2, y = y.position*1.04, label = p_char2),
    inherit.aes = FALSE,
    size = 4,
    parse = TRUE) +
  geom_segment(data = stats,
    aes(x = xmin, xend = xmax, y = y.position, yend = y.position),
    inherit.aes = FALSE,
    size = 0.5,
    color = "black") +
 theme(legend.position="blank", plot.title = element_text(hjust = 0.5, size=12))
myplot1

my_order_big=c("Bacterial/viral\nLRTI", "Viral\nLRTI", "Bacterial/viral\nIPC", "Viral\nIPC", "CTRL")
group_positions1 <- setNames(seq_along(my_order_big), my_order_big)

trimmed<-load_data %>% filter(grepl("Viral|Control|viral", category_infection_class))
statsa <-trimmed %>% 
  wilcox_test(data=.,sumlogrpm ~ category_derived) %>%
  add_significance("p") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  filter(p.adj<0.1) %>%
  mutate(y.position = c(5.25,6, 6.75,7.5)) %>%
  mutate(xmin=pmin(group_positions1[group1], group_positions1[group2])) %>%
  mutate(xmax=pmax(group_positions1[group1], group_positions1[group2])) %>%
  mutate(p_char = case_when(p.adj<0.01 ~ format(p.adj, scientific=TRUE, digits=2), p.adj>0.045 & p.adj<0.05 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), p.adj>0.0095 & p.adj<0.01 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p.adj,digits=2), nsmall = 2)))) %>%
    mutate(p_char2=paste0("P[adj]==", p_char))


myplot1a<-ggplot(trimmed, aes(x=factor(category_derived, my_order_big), y=sumlogrpm, color=category_derived)) +
  scale_color_manual(values = c("#70A494FF","#DE8A5AFF","gray","#B4C8A8FF","#EDBB8AFF"), na.value="gray2") +
  #geom_point(position = position_jitterdodge(0.3,0.2,0.6), alpha=0.6, size=3) +
  geom_quasirandom(alpha = 0.5, size = 2.5, dodge.width = 0.6) + 
  geom_boxplot(alpha=0.5, outlier.shape=NA, fill=NA, width=0.6) +
  xlab("Infection Status") + ylab(expression(paste("Log-transformed viral ",Sigma, "(NT RPM)"))) + labs(color="", title="Viral abundance by subgroup") + 
  #geom_line(group="pt_id") + ### add this line if before and after with same patient
  geom_text(data = statsa,
    aes(x = (xmin+xmax)/2, y = y.position*1.05, label = p_char2),
    inherit.aes = FALSE,
    size = 4,
    parse = TRUE) +
  geom_segment(data = statsa,
    aes(x = xmin, xend = xmax, y = y.position, yend = y.position),
    inherit.aes = FALSE,
    size = 0.5,
    color = "black") +
  theme(axis.text.x = element_text(), legend.position="blank", plot.title = element_text(hjust = 0.5, size=12))
myplot1a

png(file="~/IvC/Figures/101325/Fig_2E.png", 5,5,"in",res=300)
plot(myplot1)
invisible(capture.output(dev.off()))

png(file="~/IvC/Figures/101325/SuppFig_S3B.png", 8,5,"in",res=300)
plot(myplot1a)
invisible(capture.output(dev.off()))

```

### GLM corrected for gender and age

```{r}
myglm_data<-load_data %>% 
  mutate(gender = factor(gender, levels=c("Male", "Female")))
myglm<-glm(sumlogrpm ~ infection_derived + gender + age, data = myglm_data)
summary(myglm)

myglm_data<-trimmed %>% 
  mutate(gender = factor(gender, levels=c("Male", "Female")))
myglm<-glm(sumlogrpm ~ category_infection_class + gender + age, data = myglm_data)
summary(myglm)
```
### Microbial Diversity - Species Richness ###

```{r species richness}
load_data <- my_data %>%
  filter(nt_count>=1, nr_count>=1, nt_alignment_length>=50, p_adj<0.05) %>%
  dplyr::filter(category=="viruses" | nt_count>=10) %>%
  group_by(sample_name) %>%
  dplyr::mutate(num_sp = n(), log_sp=log(num_sp), sqrt_sp=sqrt(num_sp)) %>% 
  ungroup() %>%
  left_join(metadata %>% dplyr::select(sample_name, category_infection_class, gender, age)) %>%
  mutate(infection_derived=case_when(
    grepl("LRTI", category_infection_class) ~ "LRTI", 
    grepl("colonizer", category_infection_class) ~ "IPC", 
    grepl("Control", category_infection_class, ignore.case = TRUE) ~ "CTRL",
    TRUE ~ "NA")) %>% 
  filter(infection_derived!="NA") %>%
  distinct(sample_name, num_sp, infection_derived, gender, age, category_infection_class, log_sp, sqrt_sp) 

my_order<-c("LRTI", "IPC", "CTRL")
group_positions=setNames(seq_along(my_order), my_order)

stats <-load_data %>% 
  wilcox_test(data=.,log_sp ~ infection_derived) %>%
  add_significance("p") %>%
  adjust_pvalue(method = "bonferroni") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  mutate(y.position = c(6.0,6.5,7)) %>%
  mutate(xmin=pmin(group_positions[group1], group_positions[group2])) %>%
  mutate(xmax=pmax(group_positions[group1], group_positions[group2])) %>%
  mutate(p_char = case_when(p.adj<0.01 ~ format(p.adj, scientific=TRUE, digits=2), p.adj>0.045 & p.adj<0.05 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), p.adj>0.0095 & p.adj<0.01 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p.adj,digits=2), nsmall = 2)))) %>%
  mutate(p_char2=paste("P[adj]==",p_char))


rich <- ggplot(load_data, aes(x = factor(infection_derived, my_order),
                            y = log_sp,
                            color = infection_derived)) +
  # Custom colors
  scale_color_manual(values = c("gray", "#008080FF", "#CA562CFF"), na.value = "gray2") +
  # Violin for distribution shape
  geom_violin(alpha = 0.2, fill = NA, linewidth = 0.5) +
  # Beeswarm (quasirandom) for individual points
  geom_quasirandom(alpha = 0.5, size = 1.5, dodge.width = 0.6) +
  # Boxplot overlay
  geom_boxplot(alpha = 0.4, outlier.shape = NA, fill = NA, width = 0.1, linewidth = 0.8) +
  # Labels and styling
   xlab("Infection Status") + ylab("Log-transformed microbial species richness") + labs(color="", title="Species richness by group") + 
  # Statistical annotation
    geom_text(data = stats,
    aes(x = (xmin+xmax)/2, y = y.position*1.04, label = p_char2),
    inherit.aes = FALSE,
    size = 4,
    parse = TRUE) +
  geom_segment(data = stats,
    aes(x = xmin, xend = xmax, y = y.position, yend = y.position),
    inherit.aes = FALSE,
    size = 0.5,
    color = "black") +
  # Themes
  theme(legend.position="blank", plot.title = element_text(hjust = 0.5, size=12))

# Print plot
rich

png(file="~/IvC/Figures/101325/Fig_2B.png", 5,5,"in",res=300)
plot(rich)
invisible(capture.output(dev.off()))
```

### GLM corrected for gender and age

```{r}
myglm_data<-load_data %>% 
  mutate(gender = factor(gender, levels=c("Male", "Female")))
myglm<-glm(log_sp ~ infection_derived + gender + age, data = myglm_data)
summary(myglm)

```

## Alpha Diversity - Shannon Diversity Index 


```{r alpha div all}
library(tidyr)
library(purrr)

### wrangle data ###
alpha_div<-my_data %>%
  filter(nt_count>=1, nr_count>=1, nt_alignment_length>=50, p_adj<0.05) %>%
  filter(category=="viruses" & !grepl("Haemophilus virus HP1|phage|Pseudomonas virus EL|Cucumber|Tobacco|Sanxia|Norway|Malassezia|Skokie|Yersinia virus AP10|Cherry|Corynebacterium virus|Blacklegged|Ohio|Clinch| Darwin|Brassica|Totivirus|Kadipiro|Ribgrass|Phaseolus|Newfield|Sinai|Sclerotinia|Inoviridae|Pepper mild|Propionibacterium virus|Tomato|Alfalfa|Bovine|Clover|Botrytis|Arthrobacter virus|Rabovirus|Myoviridae|anemone|Bermuda grass|Lasius|Perth bee|Mycobacterium virus|Tulip|Lysoka|Beauveria|Bell pepper|Newington|Prunus|Shahe|Cocksfoot|Soybean|Sinu virus|tombus-like|Pistacia|Brome|Kashmir bee|Streptomyces virus|Squash|Mississippi|Moroccan|Microbacterium virus|Turnip|Potato|Carnation|Hubei picorna-like virus 55|Opossum|Persea|Ryegrass|Micalovirus|Hubei tombus-like virus 31|Lactuca|Paramecium|Pectinobacterium|Oryza|Pseudomonas virus|Invertebrate|crawfish|Burkholderia|Hubei picorna-like virus 36|Sanfarnavirus|Streptococcus virus|Mamestra|Linepithema|Cockroach|Culex|Klebsiella virus|Hubei picorna-like virus 61|Carascovirus|Ubei picorna",name) | nt_count>=10) %>%
  pivot_wider(names_from = name, values_from = nt_rpm, values_fill = 0, id_cols = sample_name) %>%
  as.data.frame()
rownames(alpha_div)<-alpha_div$sample_name
input<-alpha_div[,-1]

### calc alpha div ###
library(vegan)
shannon<-vegan::diversity(input,index="shannon") %>% as.data.frame()
shan<-shannon %>% mutate(sample_name= rownames(shannon))
simp<-vegan::diversity(input,index = "simpson") %>% as.data.frame()
simp2<-simp %>% mutate(sample_name= rownames(simp))
inv<-vegan::diversity(input,index = "invsimpson") %>% as.data.frame()
inv2<-inv %>% mutate(sample_name= rownames(inv))

### attach onto metadata ###
data1<-left_join(metadata,shan,by="sample_name")
data2<-left_join(data1,simp2,by="sample_name")
data4<-left_join(data2,inv2,by="sample_name")
#data4 <-data3 %>% filter(!is_water==TRUE)
column_names<-colnames(data4)
subset<-column_names[1:(length(column_names)-3)]
add<-c("shannon_index","simpson_index","inverse_simpson")
names<-c(subset,add)
data5<-data4 %>% set_names(names)
data6<-data5 %>% filter(!is.na(shannon_index), !is.na(simpson_index), !is.na(inverse_simpson)) %>%
  mutate(infection_derived=case_when(grepl("LRTI", category_infection_class) ~ "Infection", grepl("colonizer", category_infection_class) ~ "Incidental carriage", grepl("Control", category_infection_class) ~ "Control", TRUE ~ "NA")) %>% filter(infection_derived!="NA")

my_order=c("Infection", "Incidental carriage", "Control")
group_positions <- setNames(seq_along(my_order), my_order)

### Statistical Testing
stat.test_byinfection_shannon <-data6 %>% 
  wilcox_test(data=.,shannon_index ~ infection_derived) %>%
  add_significance("p") %>%
  adjust_pvalue(method = "bonferroni") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  mutate(y.position = c(4.25,4.65,5.05)) %>%
  mutate(xmin=pmin(group_positions[group1], group_positions[group2])) %>%
  mutate(xmax=pmax(group_positions[group1], group_positions[group2])) %>%
  mutate(p_char = case_when(p.adj<0.01 ~ format(p.adj, scientific=TRUE, digits=2), p.adj>0.045 & p.adj<0.05 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), p.adj>0.0095 & p.adj<0.01 ~ as.character(format(round(p.adj,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p.adj,digits=2), nsmall = 2))))

my_order=c("LRTI", "IPC", "CTRL")
label_piece<-"P[adj]=="

stat.test_byinfection_shannon$p_char2<-paste0(label_piece,stat.test_byinfection_shannon$p_char)

data7 <-data6 %>%
  mutate(infection_derived=case_when(grepl("Infection", infection_derived) ~ "LRTI", grepl("Inciden", infection_derived) ~ "IPC", grepl("Contr", infection_derived) ~ "CTRL", TRUE ~ "NA"))

panela <- ggplot(data7, aes(x = factor(infection_derived, my_order),
                            y = shannon_index,
                            color = infection_derived)) +
  # Custom colors
  scale_color_manual(values = c("gray", "#008080FF", "#CA562CFF"), na.value = "gray2") +
  # Violin for distribution shape
  geom_violin(alpha = 0.2, fill = NA, linewidth = 0.5) +
  # Beeswarm (quasirandom) for individual points
  geom_quasirandom(alpha = 0.5, size = 1.5, dodge.width = 0.6) +
  # Boxplot overlay
  geom_boxplot(alpha = 0.4, outlier.shape = NA, fill = NA, width = 0.1, linewidth = 0.8) +
  # Labels and styling
  xlab("Infection Status") +
  ylab("Shannon diversity index") +
  labs(color = "", title = "Alpha diversity by group") +
  # Statistical annotation
    geom_text(data = stat.test_byinfection_shannon,
    aes(x = (xmin+xmax)/2, y = y.position*1.04, label = p_char2),
    inherit.aes = FALSE,
    size = 4,
    parse = TRUE) +
  geom_segment(data = stat.test_byinfection_shannon,
    aes(x = xmin, xend = xmax, y = y.position, yend = y.position),
    inherit.aes = FALSE,
    size = 0.5,
    color = "black") +
  # Themes
  theme(legend.position="blank", plot.title = element_text(hjust = 0.5, size=12))

# Print plot
panela

png(file="~/IvC/Figures/101325/Fig_2A.png", 5,5,"in",res=300)
plot(panela)
invisible(capture.output(dev.off()))
```


```{r}
myglm_data<-data6 %>% 
  mutate(gender = factor(gender, levels=c("Male", "Female")))
myglm<-glm(shannon_index ~ infection_derived + gender + age, data = myglm_data)
summary(myglm)

myglm_data<-data6 %>% 
  mutate(gender = factor(gender, levels=c("Male", "Female")))
myglm<-glm(shannon_index ~ category_infection_class + gender + age, data = myglm_data)
summary(myglm)
```

### Beta Diversity

```{r beta all}
my_dataall<-my_data %>%
  filter(nt_count>=1, nr_count>=1, nt_alignment_length>=50, p_adj<0.05) %>%
  filter(category=="viruses" &!grepl("Haemophilus virus HP1|phage|Pseudomonas virus EL|Cucumber|Tobacco|Sanxia|Norway|Malassezia|Skokie|Yersinia virus AP10|Cherry|Corynebacterium virus|Blacklegged|Ohio|Clinch| Darwin|Brassica|Totivirus|Kadipiro|Ribgrass|Phaseolus|Newfield|Sinai|Sclerotinia|Inoviridae|Pepper mild|Propionibacterium virus|Tomato|Alfalfa|Bovine|Clover|Botrytis|Arthrobacter virus|Rabovirus|Myoviridae|anemone|Bermuda grass|Lasius|Perth bee|Mycobacterium virus|Tulip|Lysoka|Beauveria|Bell pepper|Newington|Prunus|Shahe|Cocksfoot|Soybean|Sinu virus|tombus-like|Pistacia|Brome|Kashmir bee|Streptomyces virus|Squash|Mississippi|Moroccan|Microbacterium virus|Turnip|Potato|Carnation|Hubei picorna-like virus 55|Opossum|Persea|Ryegrass|Micalovirus|Hubei tombus-like virus 31|Lactuca|Paramecium|Pectinobacterium|Oryza|Pseudomonas virus|Invertebrate|crawfish|Burkholderia|Hubei picorna-like virus 36|Sanfarnavirus|Streptococcus virus|Mamestra|Linepithema|Cockroach|Culex|Klebsiella virus|Hubei picorna-like virus 61|Carascovirus|Ubei picorna",name) | nt_count>=10)

combined_data<-my_dataall%>% 
  #filter(!is_water==TRUE) %>%
  mutate(infection_derived=case_when(grepl("LRTI", category_infection_class) ~ "LRTI", grepl("colonizer", category_infection_class) ~ "IPC", grepl("Control", category_infection_class) ~ "CTRL",  TRUE ~ "NA")) %>% 
  filter(infection_derived!="NA")

pruned_data<- combined_data %>%
  select(sample_name, name, nt_count) %>%
  pivot_wider(names_from = name, values_from = nt_count) %>%
  mutate_if(is.numeric, ~replace_na(., 0))

pruned_data2<- pruned_data[,-1]
my_data_df<-as.data.frame(pruned_data2)
rownames(my_data_df) <- pruned_data$sample_name
data_transformed<-my_data_df %>% log1p() # log transform the values, with adding 1-all

### make metadata
pruned_metadata <- combined_data %>% 
  select(sample_name,infection_derived) %>% 
  distinct() %>% 
  filter(sample_name %in% rownames(my_data_df))

beta_dist <- vegdist(data_transformed)

AMR.dispersion<-betadisper(beta_dist, group=pruned_metadata$infection_derived)
AMR.permutest<-permutest(AMR.dispersion)

#plot(AMR.dispersion, hull=FALSE, ellipse=TRUE)

set.seed(100)
AMR.div<-adonis2(beta_dist ~ pruned_metadata$infection_derived, data=pruned_metadata, permutations = 1000, method="bray")

pcoa_result <- cmdscale(beta_dist, k = 2, eig = TRUE)
#plot(pcoa_result$points, xlab = "PCoA1", ylab = "PCoA2", main = "PCoA Plot")
PC1 <- pcoa_result$points[,1]
PC2 <- pcoa_result$points[,2]
plot<-cbind(pruned_metadata, PC1, PC2)
cent <- aggregate(cbind(PC1, PC2) ~ infection_derived, data = pruned_metadata, FUN = mean)
segs<-merge(plot,setNames(cent, c("infection_derived", "oPC1", "oPC2")), by = "infection_derived", sort = FALSE)

PCA_plot<-ggplot(plot %>% dplyr::mutate(infection_derived=factor(infection_derived, levels=c("LRTI","IPC","CTRL"))), aes(PC1, PC2, color=infection_derived)) +
  geom_point(alpha=0.7, size=2.5) +
  stat_ellipse() +  
  geom_segment(data = segs, mapping = aes(xend = oPC1, yend = oPC2), alpha=0.3) + # spiders
  geom_point(data = cent, size = 4) +                         # centroids
  scale_color_manual(labels=c("LRTI","IPC","CTRL"), values=c("#CA562CFF","#008080FF","gray")) +
  scale_fill_manual(labels=c("LRTI","IPC","CTRL"), values=c("#CA562CFF","#008080FF","gray")) +
  annotate("text", x=-0.7, y=0.5, label=paste("P[adj] < 0.001"), hjust = 0, size=4, parse=TRUE) +
  labs(title="Microbial beta diversity by group") +
  theme(legend.position="bottom",legend.title = element_blank(),  plot.title = element_text(hjust = 0.5, size=12), legend.text = element_text(size=12)) 
#+ theme_bw()
PCA_plot
png(file="~/IvC/Figures/101325/Fig_2C.png", 5,5,"in",res=300)
plot(PCA_plot)
invisible(capture.output(dev.off()))
```

### Pathogen Proportion analysis

```{r pathogen analysis panel E all}
### read in data
rbm<-read.csv("~/IvC/revised_data_63025/VAP_rbm_06122025.csv", header=TRUE)
viral<-read.csv("~/IvC/revised_data_63025/all_virus_calls_062625.csv", header=TRUE)
knownresp<-read.csv("~/IvC/revised_data_63025/known_respiratory_pathogens_updated.csv", header=TRUE)

### limit RBM data to pathogens (n=499)
rbm_paths<-rbm %>% 
  filter(pathogen==TRUE) %>%
  mutate(sample_name_long=sample_name) %>%
  mutate(sample_name=case_when(grepl("OPS054",sample_name) ~ str_extract(sample_name_long, ".*?OPS054"), TRUE ~ sample_name_long)) %>%
  select(sample_name, sample_name_long, name, tax_id, genus_tax_id, nt_rpm)

### make file with taxids and category
taxids_categories<-microbes %>%
  select(tax_id,genus_tax_id,name,category) %>%
  distinct()

### attach categories onto pathogens
rbm_withcat <-left_join(rbm_paths, taxids_categories, by=c("tax_id","name"))

### attach infection_derived
rbm_with_infection<-left_join(rbm_withcat, metadata, by="sample_name")

### Trim & convert to infection derived (n=194)
rbm_trimmed<-rbm_with_infection %>% 
  filter(category=="bacteria") %>%
  filter(!is.na(category_infection_class)) %>%
  mutate(infection_derived=case_when(grepl("LRTI", category_infection_class) ~ "LRTI", grepl("colonizer", category_infection_class) ~ "IPC", grepl("Control", category_infection_class) ~ "CTRL", TRUE ~ "NA")) %>% 
  filter(infection_derived!="NA") 

viral_formatted <- viral %>%
  filter(name %in% knownresp$Pathogen) %>%
  mutate(sample_name_long=sample_name) %>%
  mutate(sample_name=case_when(grepl("OPS054",sample_name) ~ str_extract(sample_name_long, ".*?OPS054"), TRUE ~ sample_name_long)) %>%
  select(sample_name, sample_name_long, name, tax_id, genus_tax_id, nt_rpm)

viral_cat <- left_join(viral_formatted, taxids_categories, by=c("tax_id","name"))

### attach infection_derived
viral_with_infection<-left_join(viral_cat, metadata, by="sample_name")

### Trim & convert to infection derived (n=194)
viral_trimmed<-viral_with_infection %>% 
  filter(!is.na(category_infection_class)) %>%
  mutate(infection_derived=case_when(grepl("LRTI", category_infection_class) ~ "LRTI", grepl("colonizer", category_infection_class) ~ "IPC", grepl("Control", category_infection_class) ~ "CTRL", TRUE ~ "NA")) %>% 
  filter(infection_derived!="NA") 

### read in full dataset file
called_paths<-read.csv("~/IvC/full_dataset_postqc_annotated pathogens and infection classes.csv", header=TRUE)

bv<-bind_rows(rbm_trimmed,viral_trimmed)

### bring in full dataset for counts 
counts<-microbes %>% 
  dplyr::mutate(sample_name_long=sample_name) %>%
  dplyr::mutate(sample_name=case_when(grepl("OPS054",sample_name) ~ str_extract(sample_name_long, ".*?OPS054"), TRUE ~ sample_name)) %>%
  left_join(metadata, by="sample_name") %>%
  #filter(!is.na(patient_id)) %>%
  select(sample_name, name, nt_count) %>%
  distinct()

pathogen_load<-bv %>%
  left_join(counts, by=c("sample_name", "name")) %>%
  group_by(sample_name) %>%
  mutate(pathogen_sum=sum(nt_count)) %>%
  ungroup() %>%
  select(sample_name, pathogen_sum, category_infection_class, infection_derived, gender, age) %>%
  distinct() 

pathogen_load_bacterial<-rbm_trimmed  %>%
  left_join(counts, by=c("sample_name", "name")) %>%
  group_by(sample_name) %>%
  mutate(pathogen_sum=sum(nt_count)) %>%
  ungroup() %>%
  select(sample_name, pathogen_sum, category_infection_class, infection_derived, gender, age) %>%
  distinct() 

pathogen_load_viral<-viral_trimmed  %>%
  left_join(counts, by=c("sample_name", "name")) %>%
  group_by(sample_name) %>%
  mutate(pathogen_sum=sum(nt_count)) %>%
  ungroup() %>%
  select(sample_name, pathogen_sum, category_infection_class, infection_derived, gender, age) %>%
  distinct() 


### get nonhost info ###
sample_overviews <-read.csv("~/IvC/sample_overviews_ivc_062425.csv", header=TRUE)
so<-sample_overviews %>%
  mutate(sample_name_so = sample_name) %>%
  select(sample_name_so,reads_after_hisat2_host_filtered) %>%
  distinct()

input_data<-pathogen_load %>% 
  tidyr::crossing(so) %>%
  filter(str_detect(sample_name_so, sample_name)) %>%
  mutate(path_proportion=pathogen_sum/reads_after_hisat2_host_filtered) %>%
  mutate(category_derived=case_when(
    grepl("Viral LRTI", category_infection_class) ~ "Viral\nLRTI", 
    grepl("Bacterial/viral LRTI", category_infection_class) ~ "Bacterial/viral\nLRTI", 
    grepl("Viral colonizer", category_infection_class) ~ "Viral\nIPC", 
    grepl("Bacterial/viral colonizer", category_infection_class) ~ "Bacterial/viral\nIPC", 
    grepl("Bacterial colonizer", category_infection_class) ~ "Bacterial\nIPC", 
    grepl("Bacterial LRTI", category_infection_class) ~ "Bacterial\nLRTI", 
    grepl("Control", category_infection_class, ignore.case = TRUE) ~ "CTRL",
    TRUE ~ "NA"))

my_order<-c("LRTI", "IPC", "CTRL")
group_positions=setNames(seq_along(my_order), my_order)

statsabc <- input_data %>%
  wilcox_test(path_proportion ~ infection_derived) %>%
  add_significance("p") %>%
  filter(p < 0.05) %>%
  mutate(y.position = c(1.5)) %>%
  mutate(xmin = 1) %>%
  mutate(ymax = 2) %>%
  mutate(p_char = case_when(
    p < 0.01 ~ format(p, scientific = TRUE, digits = 2),
    p > 0.045 & p < 0.05 ~ format(round(p, 3), nsmall = 2),
    p > 0.0095 & p < 0.01 ~ format(round(p, 3), nsmall = 2),
    TRUE ~ format(round(p, 2), nsmall = 2)
  )) %>% mutate(p_char2=paste0("p==",p_char))
  
my_order_new<-c("IPC","LRTI")

panele1 <- ggplot(input_data,
                   aes(x = path_proportion,
                       y = factor(infection_derived, my_order_new),
                       fill = infection_derived,
                       color = infection_derived)) +

  # Half-violin for density
  stat_halfeye(adjust = 0.5,width = 0.6,.width = 0,
    justification = -0.3,point_colour = NA,alpha = 0.3) +
  # Raw data
  geom_quasirandom(alpha = 0.6, size = 2, width = 0.2, dodge.width = 0 ) +
  # Optional boxplot (vertical since x = value)
  geom_boxplot(width = 0.2,outlier.shape = NA,
    alpha = 0.3,color = "black") +
  # Color scales
  scale_color_manual(values = c("#008080FF", "#CA562CFF"), na.value = "gray2") +
  scale_fill_manual(values = c("#008080FF", "#CA562CFF"), na.value = "gray2") +
  # Labels
  xlab(expression(paste(Sigma," pathogen counts / non-host counts"))) +
  ylab("Infection Status") +
  labs(color = "", fill = "", title="Pathogen proportion by group") +

  #P-value annotation â€” now horizontal
  # Vertical line between y positions at fixed x
  geom_segment(aes(x = 1.05, xend = 1.05,
                   y = 1, yend = 2),
               inherit.aes = FALSE,
               linewidth = 0.5) +
  
  # Add p-value label slightly to the right
  geom_text(data = statsabc,
            aes(x = 1.05 + 0.04, y = 1.2, label = p_char2),
            inherit.aes = FALSE,
            hjust = 0,
            angle=90,
            size = 4, parse=TRUE) +


  # Theme
  theme_minimal(base_size = 12) +
  theme(
    axis.text = element_text(color = "black",size=12),
    legend.position = "none",
    panel.grid.major.y = element_blank(), 
    axis.title.y = element_blank(),
    plot.title = element_text(hjust = 0.5, size=12), 
  ) +

  scale_x_continuous(breaks = seq(0, 1, by = 0.2)) +
  coord_cartesian(clip = "off")

panele1

png(file="~/IvC/Figures/101325/Fig_2E.png", 5,5,"in",res=300)
plot(panele1)
invisible(capture.output(dev.off()))
```


```{r pathogen abundance supp fig 4}
### RSV ###
my_order<-c("LRTI", "IPC")
group_positions=setNames(seq_along(my_order), my_order)

load_data <- viral_trimmed %>%
  filter(name=="Human orthopneumovirus") %>%
  mutate(pseudo=nt_rpm+1) %>%
  dplyr::mutate(sumlogrpm = log10(pseudo)) %>% # calculate sumntrpm and transform 
  filter(infection_derived=="LRTI"|infection_derived=="IPC") %>%
  dplyr::mutate(sumlogrpm = ifelse(is.na(sumlogrpm), 0, sumlogrpm)) %>% # set sum dpm to 0 if it's NA
  distinct(sample_name, name, nt_rpm, sumlogrpm, infection_derived, gender, age, category_infection_class) 

stats <-load_data %>% 
  wilcox_test(data=.,sumlogrpm ~ infection_derived) %>%
  add_significance("p") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  mutate(y.position = c(5)) %>%
  mutate(xmin=pmin(group_positions[group1], group_positions[group2])) %>%
  mutate(xmax=pmax(group_positions[group1], group_positions[group2])) %>%
  mutate(p_char = case_when(p<0.01 ~ format(p, scientific=TRUE, digits=2), p>0.045 & p<0.05 ~ as.character(format(round(p,digits=3), nsmall = 2)), p>0.0095 & p<0.01 ~ as.character(format(round(p,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p,digits=2), nsmall = 2)))) %>%
  mutate(p_char2=paste0("p ==",p_char))


panelf1 <- ggplot(load_data, aes(x = factor(infection_derived, my_order),
                            y = sumlogrpm,
                            color = infection_derived)) +
  # Custom colors
  scale_color_manual(values = c("#008080FF", "#CA562CFF"), na.value = "gray2") +
  # Violin for distribution shape
  geom_violin(alpha = 0.2, fill = NA, linewidth = 0.5) +
  # Beeswarm (quasirandom) for individual points
  geom_quasirandom(alpha = 0.5, size = 1.5, dodge.width = 0.6) +
  # Boxplot overlay
  geom_boxplot(alpha = 0.4, outlier.shape = NA, fill = NA, width = 0.1, linewidth = 0.8) +
  # Labels and styling
  xlab("Infection Status") +
  ylab(expression(paste("RSV Log-transformed ",Sigma,"(NT RPM)"))) +
  labs(color = "", title = "RSV abundance by group") +
  # Statistical annotation
  geom_segment(aes(x = 1, xend = 2,
                   y = 4.5, yend = 4.5),
               inherit.aes = FALSE,
               linewidth = 0.5) +
  
  # Add p-value label 
  geom_text(data = stats,
            aes(x = 1.25, y = 4.7, label = p_char2),
            inherit.aes = FALSE,
            hjust = 0,
            parse=TRUE,
            size = 4) +
  # Themes
  theme(legend.position="blank", plot.title = element_text(hjust = 0.5, size=12))

# Print plot
panelf1

png(file="~/IvC/Figures/101325/SuppFig_S4A.png", 4,5,"in",res=300)
plot(panelf1)
invisible(capture.output(dev.off()))

### Rhinovirus 
load_data <- viral_trimmed %>%
  filter(grepl("Rhinovirus",name)) %>% ## select all rhinovirus hits
  group_by(sample_name) %>%
  mutate(combined_ntrpm=sum(nt_rpm)) %>%
  ungroup() %>%
  select(sample_name, infection_derived, combined_ntrpm, gender, age, category_infection_class) %>%
  distinct() %>%
  mutate(pseudo=combined_ntrpm+1) %>%
  dplyr::mutate(sumlogrpm = log10(pseudo)) %>% # calculate sumntrpm and transform 
  filter(infection_derived=="LRTI"|infection_derived=="IPC") %>%
  dplyr::mutate(sumlogrpm = ifelse(is.na(sumlogrpm), 0, sumlogrpm)) %>% # set sum dpm to 0 if it's NA
  distinct(sample_name,combined_ntrpm,sumlogrpm, infection_derived, gender, age, category_infection_class) 

stats <-load_data %>% 
  wilcox_test(data=.,sumlogrpm ~ infection_derived) %>%
  add_significance("p") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  mutate(y.position = c(5.5)) %>%
  mutate(xmin=pmin(group_positions[group1], group_positions[group2])) %>%
  mutate(xmax=pmax(group_positions[group1], group_positions[group2])) %>%
  mutate(p_char = case_when(p<0.01 ~ format(p, scientific=TRUE, digits=2), p>0.045 & p<0.05 ~ as.character(format(round(p,digits=3), nsmall = 2)), p>0.0095 & p<0.01 ~ as.character(format(round(p,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p,digits=2), nsmall = 2)))) %>%
  mutate(p_char2=paste0("p==",p_char))

panelf2 <- ggplot(load_data, aes(x = factor(infection_derived, my_order),
                            y = sumlogrpm,
                            color = infection_derived)) +
  # Custom colors
  scale_color_manual(values = c("#008080FF", "#CA562CFF"), na.value = "gray2") +
  # Violin for distribution shape
  geom_violin(alpha = 0.2, fill = NA, linewidth = 0.5) +
  # Beeswarm (quasirandom) for individual points
  geom_quasirandom(alpha = 0.5, size = 1.5, dodge.width = 0.6) +
  # Boxplot overlay
  geom_boxplot(alpha = 0.4, outlier.shape = NA, fill = NA, width = 0.1, linewidth = 0.8) +
  # Labels and styling
  xlab("Infection Status") +
  ylab(expression(paste("Rhinovirus log-transformed ",Sigma,"(NT RPM)"))) +
  labs(color = "", title = "Rhinovirus abundance by group") +
  # Statistical annotation
    geom_segment(aes(x = 1, xend = 2,
                   y = 5, yend = 5),
               inherit.aes = FALSE,
               linewidth = 0.5) +
  
  # Add p-value label 
  geom_text(data = stats,
            aes(x = 1.25, y = 5.2, label = p_char2),
            inherit.aes = FALSE,
            hjust = 0,
            parse=TRUE,
            size = 4) +
  # Themes
  theme(legend.position="blank", plot.title = element_text(hjust = 0.5, size=12))

# Print plot
panelf2

png(file="~/IvC/Figures/101325/SuppFig_S4B.png", 4,5,"in",res=300)
plot(panelf2)
invisible(capture.output(dev.off()))

### H flu
load_data <- rbm_trimmed %>%
  filter(name=="Haemophilus influenzae") %>%
  mutate(pseudo=nt_rpm+1) %>%
  dplyr::mutate(sumlogrpm = log10(pseudo)) %>% # calculate sumntrpm and transform 
  filter(infection_derived=="LRTI"|infection_derived=="IPC") %>%
  dplyr::mutate(sumlogrpm = ifelse(is.na(sumlogrpm), 0, sumlogrpm)) %>% # set sum dpm to 0 if it's NA
  distinct(sample_name, name, nt_rpm, sumlogrpm, infection_derived, gender, age, category_infection_class) 

stats <-load_data %>% 
  wilcox_test(data=.,sumlogrpm ~ infection_derived) %>%
  add_significance("p") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  mutate(y.position = c(5.5)) %>%
  mutate(xmin=pmin(group_positions[group1], group_positions[group2])) %>%
  mutate(xmax=pmax(group_positions[group1], group_positions[group2])) %>%
  mutate(p_char = case_when(p<0.01 ~ format(p, scientific=TRUE, digits=2), p>0.045 & p<0.05 ~ as.character(format(round(p,digits=3), nsmall = 2)), p>0.0095 & p<0.01 ~ as.character(format(round(p,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p,digits=2), nsmall = 2)))) %>%
  mutate(p_char2=paste0("p==",p_char))

panelf3 <- ggplot(load_data, aes(x = factor(infection_derived, my_order),
                            y = sumlogrpm,
                            color = infection_derived)) +
  # Custom colors
  scale_color_manual(values = c("#008080FF", "#CA562CFF"), na.value = "gray2") +
  # Violin for distribution shape
  geom_violin(alpha = 0.2, fill = NA, linewidth = 0.5) +
  # Beeswarm (quasirandom) for individual points
  geom_quasirandom(alpha = 0.5, size = 1.5, dodge.width = 0.6) +
  # Boxplot overlay
  geom_boxplot(alpha = 0.4, outlier.shape = NA, fill = NA, width = 0.1, linewidth = 0.8) +
  # Labels and styling
  xlab("Infection Status") +
  ylab(expression(paste(italic("H. influenzae")," log-transformed ",Sigma,"(NT RPM)"))) +
  labs(color = "", title = expression(paste(italic("H. influenzae")," abundance by group"))) +
  # Statistical annotation
  geom_segment(aes(x = 1, xend = 2,
                   y = 5.5, yend = 5.5),
               inherit.aes = FALSE,
               linewidth = 0.5) +
  
  # Add p-value label 
  geom_text(data = stats,
            aes(x = 1.25, y = 5.7, label = p_char2),
            inherit.aes = FALSE,
            hjust = 0,
            parse=TRUE,
            size = 4) +
  # Themes
  theme(legend.position="blank", plot.title = element_text(hjust = 0.5, size=12))

# Print plot
panelf3

png(file="~/IvC/Figures/101325/SupFig_S4C.png", 4,5,"in",res=300)
plot(panelf3)
invisible(capture.output(dev.off()))

### Moraxella
load_data <- rbm_trimmed %>%
  filter(name=="Moraxella catarrhalis") %>%
  mutate(pseudo=nt_rpm+1) %>%
  dplyr::mutate(sumlogrpm = log10(pseudo)) %>% # calculate sumntrpm and transform 
  filter(infection_derived=="LRTI"|infection_derived=="IPC") %>%
  dplyr::mutate(sumlogrpm = ifelse(is.na(sumlogrpm), 0, sumlogrpm)) %>% # set sum dpm to 0 if it's NA
  distinct(sample_name, name, nt_rpm, sumlogrpm, infection_derived, gender, age, category_infection_class) 

stats <-load_data %>% 
  wilcox_test(data=.,sumlogrpm ~ infection_derived) %>%
  add_significance("p") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  mutate(y.position = c(5)) %>%
  mutate(xmin=pmin(group_positions[group1], group_positions[group2])) %>%
  mutate(xmax=pmax(group_positions[group1], group_positions[group2])) %>%
  mutate(p_char = case_when(p<0.01 ~ format(p, scientific=TRUE, digits=2), p>0.045 & p<0.05 ~ as.character(format(round(p,digits=3), nsmall = 2)), p>0.0095 & p<0.01 ~ as.character(format(round(p,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p,digits=2), nsmall = 2)))) %>%
  mutate(p_char2=paste0("p==",p_char))

panelf4 <- ggplot(load_data, aes(x = factor(infection_derived, my_order),
                            y = sumlogrpm,
                            color = infection_derived)) +
  # Custom colors
  scale_color_manual(values = c("#008080FF", "#CA562CFF"), na.value = "gray2") +
  # Violin for distribution shape
  geom_violin(alpha = 0.2, fill = NA, linewidth = 0.5) +
  # Beeswarm (quasirandom) for individual points
  geom_quasirandom(alpha = 0.5, size = 1.5, dodge.width = 0.6) +
  # Boxplot overlay
  geom_boxplot(alpha = 0.4, outlier.shape = NA, fill = NA, width = 0.1, linewidth = 0.8) +
  # Labels and styling
  xlab("Infection Status") +
  ylab(expression(paste(italic("M. catarrhalis")," log-transformed ",Sigma,"(NT RPM)"))) +
  labs(color = "", title = expression(paste(italic("M. catarrhalis")," abundance by group"))) +
  # Statistical annotation
  geom_segment(aes(x = 1, xend = 2,
                   y = 5, yend = 5),
               inherit.aes = FALSE,
               linewidth = 0.5) +
  
  # Add p-value label 
  geom_text(data = stats,
            aes(x = 1.25, y = 5.2, label = p_char2),
            inherit.aes = FALSE,
            hjust = 0,
            parse=TRUE,
            size = 4) +
  # Themes
  theme(legend.position="blank", plot.title = element_text(hjust = 0.5, size=12))

# Print plot
panelf4

png(file="~/IvC/Figures/101325/SuppFig_S4D.png", 4,5,"in",res=300)
plot(panelf4)
invisible(capture.output(dev.off()))
```

### Differential Abundance Analysis - ANCOM ###

```{r ANCOM setup}
library(phyloseq)
library(ANCOMBC)
### Prep data

### join microbes to metadata
my_data<-microbes %>% 
  dplyr::mutate(sample_name_long=sample_name) %>%
  dplyr::mutate(sample_name=case_when(grepl("OPS054",sample_name) ~ str_extract(sample_name_long, ".*?OPS054"), TRUE ~ sample_name)) %>%
  left_join(metadata, by="sample_name") 

my_data_bacterial<-microbes %>% 
  dplyr::mutate(sample_name_long=sample_name) %>%
  filter(category=="bacteria") %>%
  dplyr::mutate(sample_name=case_when(grepl("OPS054",sample_name) ~ str_extract(sample_name_long, ".*?OPS054"), TRUE ~ sample_name)) %>%
  left_join(metadata, by="sample_name") 

### Create and format metadata
metadata <-metadata %>% select(sample_name, category_infection_class, gender, age) %>%
  mutate(infection_derived=case_when(
    grepl("LRTI", category_infection_class) ~ "LRTI", 
    grepl("colonizer", category_infection_class) ~ "IPC", 
    grepl("control", category_infection_class, ignore.case = TRUE) ~ "CTRL",
    TRUE ~ "NA"))
rownames(metadata) <- metadata[,1]

metadata2 <- metadata %>%
  mutate(infection_derived = factor(infection_derived, c( "CTRL", "IPC", "NA","LRTI")))

### create counts file
counts<-my_data %>% 
  pivot_wider(names_from = name, id_cols = sample_name, values_from = nt_count, values_fill=0)

counts_bacterial<-my_data_bacterial %>% 
  pivot_wider(names_from = name, id_cols = sample_name, values_from = nt_count, values_fill=0)

counts_rsv<-my_data %>% 
  pivot_wider(names_from = name, id_cols = sample_name, values_from = nt_count, values_fill=0) %>%
  mutate(RSV=`Respiratory syncytial virus`+ `Human orthopneumovirus`) %>%
  select(-`Respiratory syncytial virus`) %>%
  select(-`Human orthopneumovirus`) 

taxa<-my_data %>% select(name, tax_id) %>% distinct()
```

```{r ANCOM LRTI vs IPC}
library(ComplexHeatmap)
library(colorRamp2)

### Trim data
meta1<-metadata2 %>% filter(infection_derived=="LRTI" | infection_derived=="IPC")
counts1<-counts_rsv %>% filter(sample_name %in% meta1$sample_name) 
counts2<- t(counts1[,-1])
colnames(counts2)<-counts1$sample_name

### Format
counts_ancom<-as.matrix(counts2)

set.seed(123)
out <- ancombc2(
  fix_formula = "infection_derived + age + gender",
  rand_formula = NULL,
  lib_cut = 0,
  group = "infection_derived",
  p_adj_method = "BH",
  pseudo = 1,
  pseudo_sens = TRUE,
  prv_cut = 0.05,
  struc_zero = TRUE,
  data = counts_ancom,
  meta_data = meta1,
  verbose = TRUE,
  neg_lb = TRUE,
  alpha = 0.05,
  global = TRUE
)

res<-out$res

ancom_summary <- tibble(
  Taxon = res$taxon,
  lfc = res$lfc_infection_derivedLRTI,
  q_val = res$q_infection_derivedLRTI,
  diff_abn = res$diff_infection_derivedLRTI) 

filtered<-ancom_summary %>% filter(lfc>0.5 | lfc<(-0.5))

### rename Neisseria 
resv<-res %>% mutate(taxon=case_when(grepl("Neisseria menin",taxon) ~ "Neisseria sp.", TRUE ~ taxon))

# Create a volcano-ready data frame
volcano_df <- data.frame(
  taxa = resv$taxon,
  logFC = resv$lfc_infection_derivedLRTI,                  # log fold change
  pval = resv$p_infection_derivedLRTI,                 # unadjusted p-value
  padj = resv$q_infection_derivedLRTI,                # FDR-adjusted p-value
  detected = resv$diff_infection_derivedLRTI        # TRUE/FALSE if significantly different
)

volcano_df <- volcano_df %>%
  mutate(
    neg_log10_padj = -log10(padj),
    sig = case_when(
      padj < 0.05 & logFC<0  ~ "Increased in IPC",
      padj <0.05 & logFC>0 ~ "Increased in LRTI",
      TRUE ~ "Not significant"
    )
  )

library(ggplot2)
library(ggrepel)

ggplot(volcano_df, aes(x = logFC, y = neg_log10_padj, label = taxa)) +
  geom_point(aes(color = sig), size = 3, alpha = 0.7) +
  scale_color_manual(values = c("Increased in LRTI" = "#CA562CFF","Increased in IPC" = "#008080FF","Not significant" = "gray70")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "gray70") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "gray70") +
  theme_minimal(base_size = 12) +
  labs(
    x = "Log fold change",
    y = expression(-log[10]("adjusted p-value")),
    title = "Differential taxonomic abundance (ANCOM-BC)",
    color = "Significance"
  ) +
  theme(legend.position = "bottom", legend.title = element_blank(),
        legend.text=element_text(size=10),
        plot.title = element_text(hjust = 0.5,size=12),
        axis.title = element_text(size=12),
        axis.text = element_text(size=12)) + 

  geom_text_repel(
    data = subset(volcano_df, sig!="Not significant"),
    aes(label = taxa, color = sig),    # ðŸ‘ˆ color segments by group
    max.overlaps = Inf,
    size = 3,
    box.padding = 0.3,
    show.legend = FALSE,
    min.segment.length = 0
  )->myplot
myplot

png(filename="~/IvC/Figures/101325/Fig_2F.png", 5,5,"in",res=300)
myplot
dev.off()

write.csv(resv, "SuppData1.csv")

```

### Virulence Factor Analysis

```{r read in data}
blast<-read.table("~/IvC/VFDB/combined_blastn_results.tsv", sep="\t",header=TRUE)
info<-read.table("~/IvC/VFDB/VF_info_file", sep="\t",header=TRUE)

blast2 <-blast %>% mutate(VFid=str_extract(subject_id,"VFG\\d+"))

results<-left_join(blast2,info, by="VFid")

results_filtered<-results %>% filter(evalue<=1e-10)

results_strict<-results %>% filter(evalue<=1e-50)
```

```{r add summary stats}
### metadata ###
sample_list<-read.csv("~/IvC/revised_data_63025/metadata_newlabels_062725.csv", header=TRUE)
metadata<-sample_list %>%
  mutate(gender=X_SEX, age=X_AGE_YEARS, category_infection_class=NEW_label_subclass) %>%
  select(sample_name,gender,age,category_infection_class) 

meta_patient<-metadata %>% distinct(sample_name,patient_id)


### add in total reads from sample overviews file 
sample_overviews<-read.csv("~/IvC/sample_overviews_vap_0313.csv", header=TRUE)
so <-sample_overviews %>% 
  mutate(sample_name=case_when(grepl("OPS_00\\d|OPS016_|VAP_RNA_TA_|VAP\\d_|VAP2019",sample_name) ~ str_extract(sample_name,".*?(?=_S\\d+)"), grepl("VAP-2020", sample_name) ~ str_extract(sample_name,".*?(?=_nov)"), TRUE ~ sample_name))

### only keep 343, add infection derived ###
my_data<-results_filtered %>%
  mutate(sample_name=case_when(grepl("OPS_00\\d|OPS016_|VAP_RNA_TA_|VAP\\d_|VAP2019",sample) ~ str_extract(sample,".*?(?=_S\\d+)"), grepl("VAP-2020", sample) ~ str_extract(sample,".*?(?=_nov)"), TRUE ~ sample)) %>%
  left_join(metadata,by="sample_name") %>%
  filter(!is.na(category_infection_class)) %>%
  mutate(infection_derived=case_when(grepl("LRTI", category_infection_class) ~ "Infection", grepl("colonizer", category_infection_class) ~ "Incidental Carriage", grepl("Control", category_infection_class) ~ "Control", TRUE ~ "NA")) %>%
  left_join(so, by="sample_name")
### 254 samples ###

### strict 
my_data_strict<-results_strict %>%
  mutate(sample_name=case_when(grepl("OPS_00\\d|OPS016_|VAP_RNA_TA_|VAP\\d_|VAP2019",sample) ~ str_extract(sample,".*?(?=_S\\d+)"), grepl("VAP-2020", sample) ~ str_extract(sample,".*?(?=_nov)"), TRUE ~ sample)) %>%
  left_join(metadata,by="sample_name") %>%
  filter(!is.na(category_infection_class)) %>%
  mutate(infection_derived=case_when(grepl("LRTI", category_infection_class) ~ "Infection", grepl("colonizer", category_infection_class) ~ "Incidental Carriage", grepl("Control", category_infection_class) ~ "Control", TRUE ~ "NA")) %>%
  left_join(so, by="sample_name")

### 180 samples ###

```

```{r create read, rpm, dpm}

### Remember to remove control and exclude from analyses downstream
data_read_level_all<-my_data%>%
  mutate(gene_length=length.y, hit_length=length.x) %>%
  group_by(sample) %>%
  mutate(sample_total_reads=n(),
         million_reads=total_reads/1000000,
         sample_total_rpm=sample_total_reads/million_reads) %>%
  ungroup() %>%
  group_by(sample,VFid) %>%
  mutate(sample_vfid_reads=n(),
         sample_vfid_bases=sum(hit_length),
         sample_vfid_coverage=sample_vfid_bases/gene_length,
         sample_vfid_dpm=sample_vfid_coverage/million_reads,
         sample_vfid_rpm=sample_vfid_reads/million_reads) %>%
  ungroup() %>%
  group_by(sample,category) %>%
  mutate(sample_category_reads=n(),
         sample_category_rpm=sample_category_reads/million_reads) %>%
  ungroup() %>%
  select(sample_name, VFid, VF, category, gene_length, total_reads, million_reads, sample_total_reads, sample_total_rpm, sample_vfid_reads, sample_vfid_bases, sample_vfid_coverage, sample_vfid_rpm, sample_vfid_dpm, sample_category_reads, sample_category_rpm, category_infection_class, infection_derived) %>%
  distinct()

data_read_level<-my_data%>%
  mutate(gene_length=length.y, hit_length=length.x) %>%
  filter(grepl("Infection|Incidental Carriage", infection_derived)) %>%
  group_by(sample) %>%
  mutate(sample_total_reads=n(),
         million_reads=total_reads/1000000,
         sample_total_rpm=sample_total_reads/million_reads) %>%
  ungroup() %>%
  group_by(sample,VFid) %>%
  mutate(sample_vfid_reads=n(),
         sample_vfid_bases=sum(hit_length),
         sample_vfid_coverage=sample_vfid_bases/gene_length,
         sample_vfid_dpm=sample_vfid_coverage/million_reads,
         sample_vfid_rpm=sample_vfid_reads/million_reads) %>%
  ungroup() %>%
  group_by(sample,category) %>%
  mutate(sample_category_reads=n(),
         sample_category_rpm=sample_category_reads/million_reads) %>%
  ungroup() %>%
  select(sample_name, VFid, VF, category, gene_length, total_reads, million_reads, sample_total_reads, sample_total_rpm, sample_vfid_reads, sample_vfid_bases, sample_vfid_coverage, sample_vfid_rpm, sample_vfid_dpm, sample_category_reads, sample_category_rpm, category_infection_class, infection_derived) %>%
  distinct()

data_vf_level_all<- data_read_level %>%
  group_by(VF) %>%
  mutate(vf_total_reads=sum(sample_vfid_reads),
         vf_total_rpm=sum(sample_vfid_rpm),
         vf_total_dpm=sum(sample_vfid_dpm)) %>%
  ungroup() %>%
  group_by(category) %>%
  mutate(category_total_reads=sum(sample_category_reads),
         category_total_rpm=sum(sample_category_rpm),
         category_total_dpm=sum(sample_vfid_dpm)) %>%
  ungroup() %>%
  select(VF,category, vf_total_reads, vf_total_rpm, category_total_reads, category_total_rpm, category_total_dpm) %>%
  distinct()

data_vf_level<- data_read_level %>%
  filter(grepl("Infection|Incidental Carriage", infection_derived)) %>%
  group_by(VF) %>%
  mutate(vf_total_reads=sum(sample_vfid_reads),
         vf_total_rpm=sum(sample_vfid_rpm),
         vf_total_dpm=sum(sample_vfid_dpm)) %>%
  ungroup() %>%
  group_by(category) %>%
  mutate(category_total_reads=sum(sample_category_reads),
         category_total_rpm=sum(sample_category_rpm),
         category_total_dpm=sum(sample_vfid_dpm)) %>%
  ungroup() %>%
  select(VF,category, vf_total_reads, vf_total_rpm, category_total_reads, category_total_rpm, category_total_dpm) %>%
  distinct()
```

```{r create read, rpm, dpm strict}

### Remember to remove control and exclude from analyses downstream
data_read_level_all_strict<-my_data_strict %>%
  mutate(gene_length=length.y, hit_length=length.x) %>%
  group_by(sample) %>%
  mutate(sample_total_reads=n(),
         million_reads=total_reads/1000000,
         sample_total_rpm=sample_total_reads/million_reads) %>%
  ungroup() %>%
  group_by(sample,VFid) %>%
  mutate(sample_vfid_reads=n(),
         sample_vfid_bases=sum(hit_length),
         sample_vfid_coverage=sample_vfid_bases/gene_length,
         sample_vfid_dpm=sample_vfid_coverage/million_reads,
         sample_vfid_rpm=sample_vfid_reads/million_reads) %>%
  ungroup() %>%
  group_by(sample,category) %>%
  mutate(sample_category_reads=n(),
         sample_category_rpm=sample_category_reads/million_reads) %>%
  ungroup() %>%
  select(sample_name, VFid, VF, category, gene_length, total_reads, million_reads, sample_total_reads, sample_total_rpm, sample_vfid_reads, sample_vfid_bases, sample_vfid_coverage, sample_vfid_rpm, sample_vfid_dpm, sample_category_reads, sample_category_rpm, category_infection_class, infection_derived) %>%
  distinct()

data_read_level_strict<-my_data_strict %>%
  mutate(gene_length=length.y, hit_length=length.x) %>%
  filter(grepl("Infection|Incidental Carriage", infection_derived)) %>%
  group_by(sample) %>%
  mutate(sample_total_reads=n(),
         million_reads=total_reads/1000000,
         sample_total_rpm=sample_total_reads/million_reads) %>%
  ungroup() %>%
  group_by(sample,VFid) %>%
  mutate(sample_vfid_reads=n(),
         sample_vfid_bases=sum(hit_length),
         sample_vfid_coverage=sample_vfid_bases/gene_length,
         sample_vfid_dpm=sample_vfid_coverage/million_reads,
         sample_vfid_rpm=sample_vfid_reads/million_reads) %>%
  ungroup() %>%
  group_by(sample,category) %>%
  mutate(sample_category_reads=n(),
         sample_category_rpm=sample_category_reads/million_reads) %>%
  ungroup() %>%
  select(sample_name, VFid, VF, category, gene_length, total_reads, million_reads, sample_total_reads, sample_total_rpm, sample_vfid_reads, sample_vfid_bases, sample_vfid_coverage, sample_vfid_rpm, sample_vfid_dpm, sample_category_reads, sample_category_rpm, category_infection_class, infection_derived) %>%
  distinct()

data_vf_level_all_strict<- data_read_level_strict %>%
  group_by(VF) %>%
  mutate(vf_total_reads=sum(sample_vfid_reads),
         vf_total_rpm=sum(sample_vfid_rpm),
         vf_total_dpm=sum(sample_vfid_dpm)) %>%
  ungroup() %>%
  group_by(category) %>%
  mutate(category_total_reads=sum(sample_category_reads),
         category_total_rpm=sum(sample_category_rpm),
         category_total_dpm=sum(sample_vfid_dpm)) %>%
  ungroup() %>%
  select(VF,category, vf_total_reads, vf_total_rpm, category_total_reads, category_total_rpm, category_total_dpm) %>%
  distinct()

data_vf_level_strict<- data_read_level_strict %>%
  filter(grepl("Infection|Incidental Carriage", infection_derived)) %>%
  group_by(VF) %>%
  mutate(vf_total_reads=sum(sample_vfid_reads),
         vf_total_rpm=sum(sample_vfid_rpm),
         vf_total_dpm=sum(sample_vfid_dpm)) %>%
  ungroup() %>%
  group_by(category) %>%
  mutate(category_total_reads=sum(sample_category_reads),
         category_total_rpm=sum(sample_category_rpm),
         category_total_dpm=sum(sample_vfid_dpm)) %>%
  ungroup() %>%
  select(VF,category, vf_total_reads, vf_total_rpm, category_total_reads, category_total_rpm, category_total_dpm) %>%
  distinct()

### output raw vfs ###
raw_vf<-data_read_level_all %>% 
  left_join(meta_patient, by="sample_name") %>%
  left_join(map, by="patient_id")  %>%
  select(-sample_name.x, -sample_name.y, -patient_id) %>%
  select(Patient, VFid, VF, category, gene_length, total_reads,     sample_total_reads, sample_total_rpm, sample_vfid_reads, sample_vfid_bases, sample_vfid_coverage,sample_vfid_rpm, sample_vfid_dpm, sample_category_reads,sample_category_rpm, category_infection_class, infection_derived)

write.csv(raw_vf, "~/IvC/virulence_factors.csv")

```

```{r ANCOM of VFs}
library(ANCOMBC)
library(ComplexHeatmap)
library(circlize)

metadata$age <-as.integer(metadata$age)

### Create and format metadata
metadata2 <-metadata %>% select(sample_name, category_infection_class, gender, age) %>%
  mutate(infection_derived=case_when(
    grepl("LRTI", category_infection_class) ~ "Infection", 
    grepl("colonizer", category_infection_class) ~ "Incidental Carriage", 
    grepl("control", category_infection_class, ignore.case = TRUE) ~ "Control",
    TRUE ~ "NA"))
rownames(metadata2) <- metadata2[,1]

metadata3 <- metadata2 %>%
  mutate(infection_derived = factor(infection_derived, c( "Control", "Incidental Carriage", "NA","Infection")))

### create counts file
counts<-collapsed %>% pivot_wider(names_from = VF, id_cols = sample_name, values_from = sample_vf_reads, values_fill=0)
taxa<-collapsed %>% select(VF) %>% distinct()

### Trim data
meta1<-metadata3 %>% filter(infection_derived=="Infection" | infection_derived=="Incidental Carriage")
counts1<-counts %>% filter(sample_name %in% meta1$sample_name) 
counts2<- t(counts1[,-1])
colnames(counts2)<-counts1$sample_name

### Format
counts_ancom<-as.matrix(counts2)

set.seed(123)
out <- ancombc2(
  fix_formula = "infection_derived + gender + age",
  rand_formula = NULL,
  lib_cut = 0,
  group = "infection_derived",
  p_adj_method = "BH",
  pseudo = 1,
  pseudo_sens = TRUE,
  prv_cut = 0.05,
  struc_zero = TRUE,
  data = counts_ancom,
  meta_data = meta1,
  verbose = TRUE,
  neg_lb = TRUE,
  alpha = 0.05,
  global = TRUE
)

resv<-out$res

# Create a volcano-ready data frame
volcano_df <- data.frame(
  taxa = resv$taxon,
  logFC = resv$lfc_infection_derivedInfection,                  # log fold change
  pval = resv$p_infection_derivedInfection,                 # unadjusted p-value
  padj = resv$q_infection_derivedInfection,                # FDR-adjusted p-value
  detected = resv$diff_infection_derivedInfection        # TRUE/FALSE if significantly different
)

volcano_df <- volcano_df %>%
  mutate(
    neg_log10_p = -log10(pval),
    sig = case_when(
      pval < 0.05  ~ "Significant",
      TRUE ~ "Not Significant"
    )) %>%
  mutate(taxa=case_when(grepl("HMW1/HMW2", taxa) ~ "H. influenzae | HMW1/HW2", TRUE ~ taxa))
  

library(ggplot2)
library(ggrepel)

ggplot(volcano_df, aes(x = logFC, y = neg_log10_p, label = taxa)) +
  geom_point(aes(color = sig), size = 3, alpha = 0.7) +
  scale_color_manual(values = c("Significant" = "#CA562CFF", "Not Significant" = "gray50")) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "gray50") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "gray50") +
  theme_minimal(base_size = 14) +
  labs(
    x = "Log Fold Change",
    y = expression(-log[10]("p-value")),
    title = "Differential abundance of virulence factors (ANCOM-BC)",
    color = "Significance"
  ) +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5, size=12)) + 

  geom_text_repel(
    data = subset(volcano_df, abs(logFC) > 0.5),
    aes(label = taxa),
    size = 3.5,
    max.overlaps = 10
  ) -> my_plot

my_plot

png(filename="~/IvC/Figures/101325/SuppFig_5.png",6,5,"in", res=300)
my_plot
dev.off()

write.csv(resv,"SuppData2.csv")

```
### Haemophlius VF Analysis

```{r hmw hxu}
path_data_hi2 <-data_read_level %>%
  filter(grepl("H. influenzae",VF)) %>%
  group_by(sample_name) %>%
  mutate(hi_sumdpm=sum(sample_vfid_dpm)) %>%
  ungroup() %>%
  group_by(sample_name,VF) %>%
  mutate(hi_VF_sumdpm=sum(sample_vfid_dpm)) %>%
  ungroup()

hmw<-path_data_hi2 %>%
  filter(grepl("HMW1", VF)) %>%
  select(sample_name, VF, hi_VF_sumdpm, infection_derived) %>%
  distinct() %>%
  mutate(infection_derived=case_when(grepl("Infection",infection_derived) ~ "LRTI", grepl("Incidental", infection_derived) ~ "IPC", TRUE ~ "NA"))

label_piece="p=="
my_order=c("LRTI", "IPC")

stats <-hmw %>% 
  wilcox_test(data=.,hi_VF_sumdpm ~ infection_derived) %>%
  add_significance("p") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  mutate(xmin = 1, xmax = 2, y.position = 4000) %>%
  mutate(p_char = case_when(p<0.01 ~ format(p, scientific=TRUE, digits=2), p>0.045 & p<0.05 ~ as.character(format(round(p,digits=3), nsmall = 2)), p>0.0095 & p<0.01 ~ as.character(format(round(p,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p,digits=2), nsmall = 2)))) %>%
   mutate(p_char2=paste0(label_piece,p_char))

ggplot(hmw, aes(y = hi_VF_sumdpm, x=factor(infection_derived, my_order), color = infection_derived)) +
  scale_color_manual(values = c("#008080FF","#CA562CFF")) +
  geom_quasirandom(alpha = 0.5, size = 3, dodge.width = 0.6) +
  # Boxplot overlay
  geom_boxplot(alpha = 0.4, outlier.shape = NA, fill = NA, linewidth = 0.8)+
  xlab("Infection Status") +  ylab(expression(paste(italic("H. influenzae")," HMW1/HMW2 ", Sigma, "(DPM)"))) + labs(color="", title=expression(paste(italic("H. influenzae")," virulence factor abundance"))) + theme_mine() + 
  geom_text(data = stats,
    aes(x = (xmin+xmax)/2, y = y.position*1.05, label = p_char2),
    inherit.aes = FALSE,
    size = 4,
    parse = TRUE) +
  geom_segment(data = stats,
    aes(x = xmin, xend = xmax, y = y.position, yend = y.position),
    inherit.aes = FALSE,
    size = 0.5,
    color = "black") +
  theme(legend.position="none", plot.title = element_text(hjust = 0.5, size=12)) -> hi_plot

hi_plot

png(filename="IvC/Figures/101325/Fig_2H_HMW.png", 2.5,5,"in",res=300)
hi_plot
dev.off()

hxu<-path_data_hi2 %>%
  filter(grepl("HxuABC", VF)) %>%
  select(sample_name, VF, hi_VF_sumdpm, infection_derived) %>%
  distinct() %>%
  mutate(infection_derived=case_when(grepl("Infection",infection_derived) ~ "LRTI", grepl("Incidental", infection_derived) ~ "IPC", TRUE ~ "NA"))

label_piece="p=="

stats <-hxu %>% 
  wilcox_test(data=.,hi_VF_sumdpm ~ infection_derived) %>%
  add_significance("p") %>%
  add_xy_position(x = "Infection Status", dodge=0.4) %>% 
  mutate(xmin = 1, xmax = 2, y.position = 600) %>%
  mutate(p_char = case_when(p<0.01 ~ format(p, scientific=TRUE, digits=2), p>0.045 & p<0.05 ~ as.character(format(round(p,digits=3), nsmall = 2)), p>0.0095 & p<0.01 ~ as.character(format(round(p,digits=3), nsmall = 2)), TRUE ~ as.character(format(round(p,digits=2), nsmall = 2)))) %>%
   mutate(p_char2=paste0(label_piece,p_char))

ggplot(hxu, aes(y = hi_VF_sumdpm, x=factor(infection_derived, my_order), color = infection_derived)) +
  scale_color_manual(values = c("#008080FF","#CA562CFF")) +
  # Beeswarm (quasirandom) for individual points
  geom_quasirandom(alpha = 0.5, size = 3, dodge.width = 0.6) +
  # Boxplot overlay
  geom_boxplot(alpha = 0.4, outlier.shape = NA, fill = NA, linewidth = 0.8)+
  xlab("Infection Status") +  ylab(expression(paste(italic("H. influenzae")," HxuABC ",Sigma,"(DPM)"))) + labs(color="", title=expression(paste(italic("H. influenzae")," virulence factor abundance"))) + theme_mine() + 
  geom_text(data = stats,
    aes(x = (xmin+xmax)/2, y = y.position*1.05, label = p_char2),
    inherit.aes = FALSE,
    size = 4,
    parse = TRUE) +
  geom_segment(data = stats,
    aes(x = xmin, xend = xmax, y = y.position, yend = y.position),
    inherit.aes = FALSE,
    size = 0.5,
    color = "black") +
  theme(legend.position="none", plot.title = element_text(hjust = 0.5, size=12)) -> hi_plot

hi_plot

png(filename="IvC/Figures/101325/Fig_2H_HXU.png", 2.5,5,"in",res=300)
hi_plot
dev.off()

```


```{r}
sessionInfo()
```
